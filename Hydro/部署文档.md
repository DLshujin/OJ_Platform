# Hydro OJ 完整手动部署文档

基于实际部署经验编写的完整手动部署指南，适用于开发和生产环境

## 📋 系统配置要求

### 硬件要求
- CPU 最低1核（推荐4核）
- 内存 最低2GB（推荐6-8GB）
- 存储 60-80GB 硬盘空间
- 系统 Debian 12 / Debian 11 / Ubuntu 22.04

### 必需端口
Hydro 需要使用以下端口：
- 8888 Hydro Web服务
- 5050 Go-Judge沙箱
- 27017 MongoDB数据库

⚠️ 重要提醒：安装和安装后的所有操作均需要在 root 权限下进行！

---

## 🔧 完整手动部署流程

### 第一阶段：系统基础环境准备

#### 1.1 更新系统包
```bash
apt update && apt upgrade -y
```

#### 1.2 安装基础开发工具
```bash
apt install -y curl wget git build-essential python3 python3-pip \
    software-properties-common gnupg2 apt-transport-https ca-certificates \
    lsb-release unzip vim
```

#### 1.3 安装Node.js 22+ 和Yarn
```bash
# 安装Node.js 22
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt install -y nodejs

# 安装Yarn
npm install -g yarn

# 验证版本
node --version && yarn --version
```

### 第二阶段：数据库和服务安装

#### 2.1 安装MongoDB数据库
```bash
# 添加MongoDB官方仓库
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/debian bookworm/mongodb-org/7.0 main" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list

# 更新包列表并安装
apt update
apt install -y mongodb-org

# 启动并设置开机自启
systemctl start mongod
systemctl enable mongod
systemctl status mongod
```

#### 2.2 安装Redis缓存服务
```bash
apt install -y redis-server
systemctl start redis-server
systemctl enable redis-server
systemctl status redis-server
```

#### 2.3 安装PM2进程管理器
```bash
npm install -g pm2
```

### 第三阶段：Hydro源码部署

#### 3.1 克隆Hydro源码
```bash
cd /root
git clone https://github.com/hydro-dev/Hydro.git
cd Hydro
```

#### 3.2 安装项目依赖
```bash
yarn install
```

#### 3.3 构建项目
```bash
# 构建TypeScript
yarn build

# 构建前端UI（开发模式）
yarn build:ui:dev
```

#### 3.4 配置数据库连接
```bash
mkdir -p ~/.hydro
cat > ~/.hydro/config.json << 'EOF'
{
  "host": "127.0.0.1",
  "port": 27017,
  "name": "hydro",
  "username": "",
  "password": ""
}
EOF
```

### 第四阶段：评测环境配置

#### 4.1 安装Go-Judge沙箱
```bash
# 下载go-judge二进制文件
wget https://github.com/criyle/go-judge/releases/latest/download/go-judge_1.8.8_linux_amd64 -O /usr/bin/sandbox
chmod +x /usr/bin/sandbox

# 验证安装
/usr/bin/sandbox --version
```

#### 4.2 配置沙箱服务
```bash
# 复制mount配置
cp /root/Hydro/install/docker/judge/mount.yaml ~/.hydro/

# 创建沙箱启动脚本
cat > ~/.hydro/start_sandbox.sh << 'EOF'
#!/bin/bash
cd /root/.hydro
exec /usr/bin/sandbox -mount-conf mount.yaml
EOF

chmod +x ~/.hydro/start_sandbox.sh
```

#### 4.3 创建Linux系统级judge用户
```bash
# 创建judge系统用户
useradd -m -s /bin/bash judge
passwd judge
# 输入密码：judge123

# 为judge用户创建配置目录
su - judge -c "mkdir -p ~/.hydro"
```

#### 4.4 配置评测服务
```bash
cat > ~/.hydro/judge.yaml << 'EOF'
hosts:
  localhost:
    type: hydro
    server_url: http://127.0.0.1:8888
    uname: judge
    password: judge123
    detail: full
sandbox_host: http://127.0.0.1:5050
EOF

# 复制配置到judge用户目录
cp ~/.hydro/judge.yaml /home/judge/.hydro/
chown judge:judge /home/judge/.hydro/judge.yaml
```

#### 4.5 安装testlib.h文件
```bash
mkdir -p /root/Hydro/packages/hydrojudge/vendor/testlib
wget https://raw.githubusercontent.com/MikeMirzayanov/testlib/master/testlib.h -O /root/Hydro/packages/hydrojudge/vendor/testlib/testlib.h
```

### 第五阶段：服务启动

#### 5.1 启动核心服务
```bash
# 启动Hydro主服务
cd /root/Hydro
pm2 start packages/hydrooj/bin/hydrooj.js --name hydro-main

# 启动沙箱服务
pm2 start ~/.hydro/start_sandbox.sh --name hydro-sandbox

# 启动评测服务
pm2 start /root/Hydro/packages/hydrojudge/bin/hydrojudge.js --name hydro-judge

# 保存PM2配置
pm2 save
```

#### 5.2 验证服务状态
```bash
# 查看服务状态
pm2 status

# 测试Web服务
curl http://127.0.0.1:8888

# 查看服务日志
pm2 logs
```

### 第六阶段：用户和数据库配置

#### 6.1 创建Hydro系统内的judge用户
```bash
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db
```

在MongoDB shell中执行：
```javascript
// 创建judge用户
db.user.insertOne({
  _id: 3,
  mail: 'judge@hydro.local',
  mailLower: 'judge@hydro.local',
  uname: 'judge',
  unameLower: 'judge',
  hash: "judge123",
  salt: "",
  hashType: 'sha256',
  regat: new Date(),
  ip: ['127.0.0.1'],
  loginat: new Date(),
  loginip: '127.0.0.1',
  priv: 1,
  avatar: 'gravatar:judge@hydro.local'
})

exit
```

#### 6.2 重启服务加载配置
```bash
pm2 restart hydro-main
pm2 restart hydro-judge
```

### 第七阶段：安装题库导入模块

#### 7.1 安装hydroac-client模块
```bash
cd /root/Hydro
node packages/hydrooj/bin/hydrooj.js install https://hydro.ac/hydroac-client.zip
```

#### 7.2 手动添加模块到配置
```bash
node packages/hydrooj/bin/hydrooj.js addon add '/root/.hydro/addons/hydroac-client'
```

#### 7.3 重启主服务
```bash
pm2 restart hydro-main
```

### 第八阶段：题库导入

#### 8.1 下载一本通题库
```bash
cd /root
wget https://hydro.ac/ybtbas.zip
unzip ybtbas.zip
```

#### 8.2 导入题库
通过Web界面操作：
1. 访问 `http://服务器IP:8888`
2. 注册第一个用户（自动获得超级管理员权限）
3. 进入"题目" → "快速导入题库"
4. 点击"导入一本通编程启蒙题库"
5. 等待导入完成

#### 8.3 最终重启
```bash
pm2 restart hydro-main
```

---

## 📝 常用管理命令

### PM2服务管理
```bash
# 查看状态
pm2 status

# 重启服务
pm2 restart hydro-main
pm2 restart hydro-judge
pm2 restart hydro-sandbox

# 查看日志
pm2 logs hydro-main
pm2 logs hydro-judge --lines 100

# 停止所有服务
pm2 stop all

# 设置开机自启
pm2 startup
pm2 save
```

### 数据库管理
```bash
# 连接MongoDB
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db

# 查看用户列表
db.user.find({}, {_id: 1, uname: 1, mail: 1}).pretty()

# 清除频率限制记录
db.opcount.deleteMany({})
```

### 系统管理
```bash
# 备份数据库
mongodump --out /root/backup/$(date +%Y%m%d)

# 查看系统状态
systemctl status mongod
systemctl status redis-server
pm2 status

# 查看端口占用
netstat -tulpn | grep -E "(8044|3201|9|8888|5050|27017)"
```

---

## ⚠️ 故障排除

### 常见问题及解决方案

#### 1. Judge进程频繁重启
**现象**: PM2显示judge进程重启次数过多
**原因**: judge用户未正确创建或密码验证失败
**解决方案**:
```bash
# 停止judge进程
pm2 stop hydro-judge

# 清除频率限制记录
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db
db.opcount.deleteMany({})
db.session.deleteMany({})
exit

# 重新创建judge用户（参照第六阶段步骤）
# 重启服务
pm2 restart hydro-main
pm2 start hydro-judge
```

#### 2. 题库导入一直转圈圈
**现象**: 点击导入按钮后一直显示加载状态
**原因**: 网络下载题库速度慢或失败
**解决方案**:
```bash
# 查看导入日志
pm2 logs hydro-main -f

# 手动下载题库到本地
wget https://hydro.ac/ybtbas.zip -O /root/ybtbas.zip
cd /root && unzip ybtbas.zip

# 通过管理界面的标准导入功能指定本地路径
```

#### 3. 端口被占用
```bash
# 查找占用进程
netstat -tulpn | grep 8888
lsof -i :8888

# 杀死进程
kill -9 PID
```

#### 4. 内存不足
```bash
# 增加Node.js内存限制
export NODE_OPTIONS=--max-old-space-size=4096
```

#### 5. 服务无法启动
```bash
# 查看详细日志
pm2 logs service-name --lines 50
journalctl -u mongod -f
```

#### 6. 评测服务连接失败
```bash
# 检查沙箱状态
curl http://127.0.0.1:5050

# 检查评测配置
cat ~/.hydro/judge.yaml

# 重启评测相关服务
pm2 restart hydro-sandbox
pm2 restart hydro-judge
```

#### 7. 用户密码验证错误
**现象**: 日志显示"Unknown hash method"或"Invalid password"
**解决方案**:
```bash
# 重新设置用户密码哈希
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db

# 使用简单的sha256哈希
const crypto = require('crypto');
const salt = 'judgesalt123';
const password = 'judge123';
const hash = crypto.createHash('sha256').update(password + salt).digest('hex');

db.user.updateOne(
  {uname: "judge"}, 
  {$set: {
    hash: hash,
    salt: salt,
    hashType: 'sha256'
  }}
)
exit
```

---

## 🎉 部署完成检查清单

- ✅ Web界面可访问 `http://服务器IP:8888`
- ✅ 三个核心服务运行：hydro-main, hydro-judge, hydro-sandbox
- ✅ 管理员用户创建：通过网页注册，自动获得超级管理员权限
- ✅ Judge用户配置：Linux系统用户和Hydro数据库用户都已创建
- ✅ 评测功能正常：可以提交代码并获得评测结果
- ✅ 题库导入成功：一本通编程启蒙题库已导入

### 最终验证步骤
1. 访问 `http://服务器IP:8888`
2. 注册管理员账号并登录
3. 进入题库查看是否有一本通题目
4. 创建一个简单的A+B题目测试评测功能
5. 提交代码验证整个流程正常

### 服务状态确认
```bash
pm2 status
# 应该显示：
# hydro-main: online, 重启次数正常
# hydro-judge: online, 重启次数为0（修复后）
# hydro-sandbox: online, 重启次数正常
```

现在您的Hydro OJ系统已完全配置完成，可以正常使用！

---

## 📚 相关资源

- 官方文档：https://docs.hydro.ac/docs/Hydro/install
- 源码仓库：https://github.com/hydro-dev/Hydro
- 题库下载：https://hydro.ac/d/tk/p
- 官方QQ群：1085853538

## 🏷️ 部署总结

本次部署成功解决了以下关键问题：
1. **Judge用户配置**：正确创建了Linux系统用户和Hydro数据库用户
2. **密码验证**：使用sha256哈希解决了密码验证问题
3. **频率限制**：清除了judge频繁重启导致的限制记录
4. **题库导入**：成功安装hydroac-client模块并导入一本通题库
5. **服务稳定性**：所有服务正常运行，重启次数正常

整个部署过程体现了Hydro系统的模块化设计优势，通过精确的配置调整成功建立了稳定的评测环境。
# Hydro OJ å®Œæ•´æ‰‹åŠ¨éƒ¨ç½²æ–‡æ¡£

åŸºäºŽå®žé™…éƒ¨ç½²ç»éªŒç¼–å†™çš„å®Œæ•´æ‰‹åŠ¨éƒ¨ç½²æŒ‡å—ï¼Œé€‚ç”¨äºŽå¼€å‘å’Œç”Ÿäº§çŽ¯å¢ƒ

## ðŸ“‹ ç³»ç»Ÿé…ç½®è¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- CPU æœ€ä½Ž1æ ¸ï¼ˆæŽ¨è4æ ¸ï¼‰
- å†…å­˜ æœ€ä½Ž2GBï¼ˆæŽ¨è6-8GBï¼‰
- å­˜å‚¨ 60-80GB ç¡¬ç›˜ç©ºé—´
- ç³»ç»Ÿ Debian 12 / Debian 11 / Ubuntu 22.04

### å¿…éœ€ç«¯å£
Hydro éœ€è¦ä½¿ç”¨ä»¥ä¸‹ç«¯å£ï¼š
- 8888 Hydro WebæœåŠ¡
- 5050 Go-Judgeæ²™ç®±
- 27017 MongoDBæ•°æ®åº“

âš ï¸ é‡è¦æé†’ï¼šå®‰è£…å’Œå®‰è£…åŽçš„æ‰€æœ‰æ“ä½œå‡éœ€è¦åœ¨ root æƒé™ä¸‹è¿›è¡Œï¼

---

## ðŸ”§ å®Œæ•´æ‰‹åŠ¨éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šç³»ç»ŸåŸºç¡€çŽ¯å¢ƒå‡†å¤‡

#### 1.1 æ›´æ–°ç³»ç»ŸåŒ…
```bash
apt update && apt upgrade -y
```

#### 1.2 å®‰è£…åŸºç¡€å¼€å‘å·¥å…·
```bash
apt install -y curl wget git build-essential python3 python3-pip \
    software-properties-common gnupg2 apt-transport-https ca-certificates \
    lsb-release unzip vim
```

#### 1.3 å®‰è£…Node.js 22+ å’ŒYarn
```bash
# å®‰è£…Node.js 22
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt install -y nodejs

# å®‰è£…Yarn
npm install -g yarn

# éªŒè¯ç‰ˆæœ¬
node --version && yarn --version
```

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“å’ŒæœåŠ¡å®‰è£…

#### 2.1 å®‰è£…MongoDBæ•°æ®åº“
```bash
# æ·»åŠ MongoDBå®˜æ–¹ä»“åº“
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/debian bookworm/mongodb-org/7.0 main" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…
apt update
apt install -y mongodb-org

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
systemctl start mongod
systemctl enable mongod
systemctl status mongod
```

#### 2.2 å®‰è£…Redisç¼“å­˜æœåŠ¡
```bash
apt install -y redis-server
systemctl start redis-server
systemctl enable redis-server
systemctl status redis-server
```

#### 2.3 å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
```bash
npm install -g pm2
```

### ç¬¬ä¸‰é˜¶æ®µï¼šHydroæºç éƒ¨ç½²

#### 3.1 å…‹éš†Hydroæºç 
```bash
cd /root
git clone https://github.com/hydro-dev/Hydro.git
cd Hydro
```

#### 3.2 å®‰è£…é¡¹ç›®ä¾èµ–
```bash
yarn install
```

#### 3.3 æž„å»ºé¡¹ç›®
```bash
# æž„å»ºTypeScript
yarn build

# æž„å»ºå‰ç«¯UIï¼ˆå¼€å‘æ¨¡å¼ï¼‰
yarn build:ui:dev
```

#### 3.4 é…ç½®æ•°æ®åº“è¿žæŽ¥
```bash
mkdir -p ~/.hydro
cat > ~/.hydro/config.json << 'EOF'
{
  "host": "127.0.0.1",
  "port": 27017,
  "name": "hydro",
  "username": "",
  "password": ""
}
EOF
```

### ç¬¬å››é˜¶æ®µï¼šè¯„æµ‹çŽ¯å¢ƒé…ç½®

#### 4.1 å®‰è£…Go-Judgeæ²™ç®±
```bash
# ä¸‹è½½go-judgeäºŒè¿›åˆ¶æ–‡ä»¶
wget https://github.com/criyle/go-judge/releases/latest/download/go-judge_1.8.8_linux_amd64 -O /usr/bin/sandbox
chmod +x /usr/bin/sandbox

# éªŒè¯å®‰è£…
/usr/bin/sandbox --version
```

#### 4.2 é…ç½®æ²™ç®±æœåŠ¡
```bash
# å¤åˆ¶mounté…ç½®
cp /root/Hydro/install/docker/judge/mount.yaml ~/.hydro/

# åˆ›å»ºæ²™ç®±å¯åŠ¨è„šæœ¬
cat > ~/.hydro/start_sandbox.sh << 'EOF'
#!/bin/bash
cd /root/.hydro
exec /usr/bin/sandbox -mount-conf mount.yaml
EOF

chmod +x ~/.hydro/start_sandbox.sh
```

#### 4.3 åˆ›å»ºLinuxç³»ç»Ÿçº§judgeç”¨æˆ·
```bash
# åˆ›å»ºjudgeç³»ç»Ÿç”¨æˆ·
useradd -m -s /bin/bash judge
passwd judge
# è¾“å…¥å¯†ç ï¼šjudge123

# ä¸ºjudgeç”¨æˆ·åˆ›å»ºé…ç½®ç›®å½•
su - judge -c "mkdir -p ~/.hydro"
```

#### 4.4 é…ç½®è¯„æµ‹æœåŠ¡
```bash
cat > ~/.hydro/judge.yaml << 'EOF'
hosts:
  localhost:
    type: hydro
    server_url: http://127.0.0.1:8888
    uname: judge
    password: judge123
    detail: full
sandbox_host: http://127.0.0.1:5050
EOF

# å¤åˆ¶é…ç½®åˆ°judgeç”¨æˆ·ç›®å½•
cp ~/.hydro/judge.yaml /home/judge/.hydro/
chown judge:judge /home/judge/.hydro/judge.yaml
```

#### 4.5 å®‰è£…testlib.hæ–‡ä»¶
```bash
mkdir -p /root/Hydro/packages/hydrojudge/vendor/testlib
wget https://raw.githubusercontent.com/MikeMirzayanov/testlib/master/testlib.h -O /root/Hydro/packages/hydrojudge/vendor/testlib/testlib.h
```

### ç¬¬äº”é˜¶æ®µï¼šæœåŠ¡å¯åŠ¨

#### 5.1 å¯åŠ¨æ ¸å¿ƒæœåŠ¡
```bash
# å¯åŠ¨Hydroä¸»æœåŠ¡
cd /root/Hydro
pm2 start packages/hydrooj/bin/hydrooj.js --name hydro-main

# å¯åŠ¨æ²™ç®±æœåŠ¡
pm2 start ~/.hydro/start_sandbox.sh --name hydro-sandbox

# å¯åŠ¨è¯„æµ‹æœåŠ¡
pm2 start /root/Hydro/packages/hydrojudge/bin/hydrojudge.js --name hydro-judge

# ä¿å­˜PM2é…ç½®
pm2 save
```

#### 5.2 éªŒè¯æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æµ‹è¯•WebæœåŠ¡
curl http://127.0.0.1:8888

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
pm2 logs
```

### ç¬¬å…­é˜¶æ®µï¼šç”¨æˆ·å’Œæ•°æ®åº“é…ç½®

#### 6.1 åˆ›å»ºHydroç³»ç»Ÿå†…çš„judgeç”¨æˆ·
```bash
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db
```

åœ¨MongoDB shellä¸­æ‰§è¡Œï¼š
```javascript
// åˆ›å»ºjudgeç”¨æˆ·
db.user.insertOne({
  _id: 3,
  mail: 'judge@hydro.local',
  mailLower: 'judge@hydro.local',
  uname: 'judge',
  unameLower: 'judge',
  hash: "judge123",
  salt: "",
  hashType: 'sha256',
  regat: new Date(),
  ip: ['127.0.0.1'],
  loginat: new Date(),
  loginip: '127.0.0.1',
  priv: 1,
  avatar: 'gravatar:judge@hydro.local'
})

exit
```

#### 6.2 é‡å¯æœåŠ¡åŠ è½½é…ç½®
```bash
pm2 restart hydro-main
pm2 restart hydro-judge
```

### ç¬¬ä¸ƒé˜¶æ®µï¼šå®‰è£…é¢˜åº“å¯¼å…¥æ¨¡å—

#### 7.1 å®‰è£…hydroac-clientæ¨¡å—
```bash
cd /root/Hydro
node packages/hydrooj/bin/hydrooj.js install https://hydro.ac/hydroac-client.zip
```

#### 7.2 æ‰‹åŠ¨æ·»åŠ æ¨¡å—åˆ°é…ç½®
```bash
node packages/hydrooj/bin/hydrooj.js addon add '/root/.hydro/addons/hydroac-client'
```

#### 7.3 é‡å¯ä¸»æœåŠ¡
```bash
pm2 restart hydro-main
```

### ç¬¬å…«é˜¶æ®µï¼šé¢˜åº“å¯¼å…¥

#### 8.1 ä¸‹è½½ä¸€æœ¬é€šé¢˜åº“
```bash
cd /root
wget https://hydro.ac/ybtbas.zip
unzip ybtbas.zip
```

#### 8.2 å¯¼å…¥é¢˜åº“
é€šè¿‡Webç•Œé¢æ“ä½œï¼š
1. è®¿é—® `http://æœåŠ¡å™¨IP:8888`
2. æ³¨å†Œç¬¬ä¸€ä¸ªç”¨æˆ·ï¼ˆè‡ªåŠ¨èŽ·å¾—è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
3. è¿›å…¥"é¢˜ç›®" â†’ "å¿«é€Ÿå¯¼å…¥é¢˜åº“"
4. ç‚¹å‡»"å¯¼å…¥ä¸€æœ¬é€šç¼–ç¨‹å¯è’™é¢˜åº“"
5. ç­‰å¾…å¯¼å…¥å®Œæˆ

#### 8.3 æœ€ç»ˆé‡å¯
```bash
pm2 restart hydro-main
```

---

## ðŸ“ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2æœåŠ¡ç®¡ç†
```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# é‡å¯æœåŠ¡
pm2 restart hydro-main
pm2 restart hydro-judge
pm2 restart hydro-sandbox

# æŸ¥çœ‹æ—¥å¿—
pm2 logs hydro-main
pm2 logs hydro-judge --lines 100

# åœæ­¢æ‰€æœ‰æœåŠ¡
pm2 stop all

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### æ•°æ®åº“ç®¡ç†
```bash
# è¿žæŽ¥MongoDB
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db

# æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
db.user.find({}, {_id: 1, uname: 1, mail: 1}).pretty()

# æ¸…é™¤é¢‘çŽ‡é™åˆ¶è®°å½•
db.opcount.deleteMany({})
```

### ç³»ç»Ÿç®¡ç†
```bash
# å¤‡ä»½æ•°æ®åº“
mongodump --out /root/backup/$(date +%Y%m%d)

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
systemctl status mongod
systemctl status redis-server
pm2 status

# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tulpn | grep -E "(8044|3201|9|8888|5050|27017)"
```

---

## âš ï¸ æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. Judgeè¿›ç¨‹é¢‘ç¹é‡å¯
**çŽ°è±¡**: PM2æ˜¾ç¤ºjudgeè¿›ç¨‹é‡å¯æ¬¡æ•°è¿‡å¤š
**åŽŸå› **: judgeç”¨æˆ·æœªæ­£ç¡®åˆ›å»ºæˆ–å¯†ç éªŒè¯å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
```bash
# åœæ­¢judgeè¿›ç¨‹
pm2 stop hydro-judge

# æ¸…é™¤é¢‘çŽ‡é™åˆ¶è®°å½•
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db
db.opcount.deleteMany({})
db.session.deleteMany({})
exit

# é‡æ–°åˆ›å»ºjudgeç”¨æˆ·ï¼ˆå‚ç…§ç¬¬å…­é˜¶æ®µæ­¥éª¤ï¼‰
# é‡å¯æœåŠ¡
pm2 restart hydro-main
pm2 start hydro-judge
```

#### 2. é¢˜åº“å¯¼å…¥ä¸€ç›´è½¬åœˆåœˆ
**çŽ°è±¡**: ç‚¹å‡»å¯¼å…¥æŒ‰é’®åŽä¸€ç›´æ˜¾ç¤ºåŠ è½½çŠ¶æ€
**åŽŸå› **: ç½‘ç»œä¸‹è½½é¢˜åº“é€Ÿåº¦æ…¢æˆ–å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å¯¼å…¥æ—¥å¿—
pm2 logs hydro-main -f

# æ‰‹åŠ¨ä¸‹è½½é¢˜åº“åˆ°æœ¬åœ°
wget https://hydro.ac/ybtbas.zip -O /root/ybtbas.zip
cd /root && unzip ybtbas.zip

# é€šè¿‡ç®¡ç†ç•Œé¢çš„æ ‡å‡†å¯¼å…¥åŠŸèƒ½æŒ‡å®šæœ¬åœ°è·¯å¾„
```

#### 3. ç«¯å£è¢«å ç”¨
```bash
# æŸ¥æ‰¾å ç”¨è¿›ç¨‹
netstat -tulpn | grep 8888
lsof -i :8888

# æ€æ­»è¿›ç¨‹
kill -9 PID
```

#### 4. å†…å­˜ä¸è¶³
```bash
# å¢žåŠ Node.jså†…å­˜é™åˆ¶
export NODE_OPTIONS=--max-old-space-size=4096
```

#### 5. æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs service-name --lines 50
journalctl -u mongod -f
```

#### 6. è¯„æµ‹æœåŠ¡è¿žæŽ¥å¤±è´¥
```bash
# æ£€æŸ¥æ²™ç®±çŠ¶æ€
curl http://127.0.0.1:5050

# æ£€æŸ¥è¯„æµ‹é…ç½®
cat ~/.hydro/judge.yaml

# é‡å¯è¯„æµ‹ç›¸å…³æœåŠ¡
pm2 restart hydro-sandbox
pm2 restart hydro-judge
```

#### 7. ç”¨æˆ·å¯†ç éªŒè¯é”™è¯¯
**çŽ°è±¡**: æ—¥å¿—æ˜¾ç¤º"Unknown hash method"æˆ–"Invalid password"
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é‡æ–°è®¾ç½®ç”¨æˆ·å¯†ç å“ˆå¸Œ
cd /root/Hydro && node packages/hydrooj/bin/hydrooj.js db

# ä½¿ç”¨ç®€å•çš„sha256å“ˆå¸Œ
const crypto = require('crypto');
const salt = 'judgesalt123';
const password = 'judge123';
const hash = crypto.createHash('sha256').update(password + salt).digest('hex');

db.user.updateOne(
  {uname: "judge"}, 
  {$set: {
    hash: hash,
    salt: salt,
    hashType: 'sha256'
  }}
)
exit
```

---

## ðŸŽ‰ éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

- âœ… Webç•Œé¢å¯è®¿é—® `http://æœåŠ¡å™¨IP:8888`
- âœ… ä¸‰ä¸ªæ ¸å¿ƒæœåŠ¡è¿è¡Œï¼šhydro-main, hydro-judge, hydro-sandbox
- âœ… ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºï¼šé€šè¿‡ç½‘é¡µæ³¨å†Œï¼Œè‡ªåŠ¨èŽ·å¾—è¶…çº§ç®¡ç†å‘˜æƒé™
- âœ… Judgeç”¨æˆ·é…ç½®ï¼šLinuxç³»ç»Ÿç”¨æˆ·å’ŒHydroæ•°æ®åº“ç”¨æˆ·éƒ½å·²åˆ›å»º
- âœ… è¯„æµ‹åŠŸèƒ½æ­£å¸¸ï¼šå¯ä»¥æäº¤ä»£ç å¹¶èŽ·å¾—è¯„æµ‹ç»“æžœ
- âœ… é¢˜åº“å¯¼å…¥æˆåŠŸï¼šä¸€æœ¬é€šç¼–ç¨‹å¯è’™é¢˜åº“å·²å¯¼å…¥

### æœ€ç»ˆéªŒè¯æ­¥éª¤
1. è®¿é—® `http://æœåŠ¡å™¨IP:8888`
2. æ³¨å†Œç®¡ç†å‘˜è´¦å·å¹¶ç™»å½•
3. è¿›å…¥é¢˜åº“æŸ¥çœ‹æ˜¯å¦æœ‰ä¸€æœ¬é€šé¢˜ç›®
4. åˆ›å»ºä¸€ä¸ªç®€å•çš„A+Bé¢˜ç›®æµ‹è¯•è¯„æµ‹åŠŸèƒ½
5. æäº¤ä»£ç éªŒè¯æ•´ä¸ªæµç¨‹æ­£å¸¸

### æœåŠ¡çŠ¶æ€ç¡®è®¤
```bash
pm2 status
# åº”è¯¥æ˜¾ç¤ºï¼š
# hydro-main: online, é‡å¯æ¬¡æ•°æ­£å¸¸
# hydro-judge: online, é‡å¯æ¬¡æ•°ä¸º0ï¼ˆä¿®å¤åŽï¼‰
# hydro-sandbox: online, é‡å¯æ¬¡æ•°æ­£å¸¸
```

çŽ°åœ¨æ‚¨çš„Hydro OJç³»ç»Ÿå·²å®Œå…¨é…ç½®å®Œæˆï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼

---

## ðŸ“š ç›¸å…³èµ„æº

- å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.hydro.ac/docs/Hydro/install
- æºç ä»“åº“ï¼šhttps://github.com/hydro-dev/Hydro
- é¢˜åº“ä¸‹è½½ï¼šhttps://hydro.ac/d/tk/p
- å®˜æ–¹QQç¾¤ï¼š1085853538

## ðŸ·ï¸ éƒ¨ç½²æ€»ç»“

æœ¬æ¬¡éƒ¨ç½²æˆåŠŸè§£å†³äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š
1. **Judgeç”¨æˆ·é…ç½®**ï¼šæ­£ç¡®åˆ›å»ºäº†Linuxç³»ç»Ÿç”¨æˆ·å’ŒHydroæ•°æ®åº“ç”¨æˆ·
2. **å¯†ç éªŒè¯**ï¼šä½¿ç”¨sha256å“ˆå¸Œè§£å†³äº†å¯†ç éªŒè¯é—®é¢˜
3. **é¢‘çŽ‡é™åˆ¶**ï¼šæ¸…é™¤äº†judgeé¢‘ç¹é‡å¯å¯¼è‡´çš„é™åˆ¶è®°å½•
4. **é¢˜åº“å¯¼å…¥**ï¼šæˆåŠŸå®‰è£…hydroac-clientæ¨¡å—å¹¶å¯¼å…¥ä¸€æœ¬é€šé¢˜åº“
5. **æœåŠ¡ç¨³å®šæ€§**ï¼šæ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œé‡å¯æ¬¡æ•°æ­£å¸¸

æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹ä½“çŽ°äº†Hydroç³»ç»Ÿçš„æ¨¡å—åŒ–è®¾è®¡ä¼˜åŠ¿ï¼Œé€šè¿‡ç²¾ç¡®çš„é…ç½®è°ƒæ•´æˆåŠŸå»ºç«‹äº†ç¨³å®šçš„è¯„æµ‹çŽ¯å¢ƒã€‚
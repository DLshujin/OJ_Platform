<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在线代码编辑器</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0; 
    overflow: hidden;
  }
  .ide-container {
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    background: #1e1e1e;
    color: #d4d4d4;
    position: fixed;
    top: 0;
    left: 0;
    margin: 0;
    padding: 0;
  }
  
  .topbar {
    background: #2d2d30;
    border-bottom: 1px solid #3e3e42;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .tabs {
    display: flex;
    gap: 2px;
  }
  
  .tab {
    background: #3c3c3c;
    color: #cccccc;
    border: none;
    padding: 8px 16px;
    cursor: pointer;
    border-radius: 4px 4px 0 0;
    transition: all 0.2s ease;
  }
  
  .tab.active {
    background: #007acc;
    color: white;
  }
  
  .tab:hover:not(.active) {
    background: #4a4a4a;
  }
  
  .actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .btn {
    background: #0e639c;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    background: #1177bb;
    color: white;
    text-decoration: none;
  }
  
  .btn.run {
    background: #16a085;
  }
  
  .btn.run:hover {
    background: #1abc9c;
  }
  
  .workspace {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: #3e3e42;
  }
  
  .editor-pane {
    background: #1e1e1e;
    display: flex;
    flex-direction: column;
  }
  
  #editor {
    flex: 1;
  }
  
  .stdin {
    background: #2d2d30;
    border-top: 1px solid #3e3e42;
    padding: 10px;
  }
  
  .stdin label {
    display: block;
    color: #cccccc;
    font-size: 12px;
    margin-bottom: 5px;
  }
  
  .stdin textarea {
    width: 100%;
    height: 80px;
    background: #1e1e1e;
    color: #d4d4d4;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    padding: 8px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    resize: vertical;
  }
  
  .output-pane {
    background: #0c0c0c;
    display: flex;
    flex-direction: column;
  }
  
  .output-toolbar {
    background: #2d2d30;
    padding: 8px 15px;
    border-bottom: 1px solid #3e3e42;
    font-size: 12px;
    color: #cccccc;
  }
  
  .output {
    flex: 1;
    background: #0c0c0c;
    color: #d4d4d4;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    padding: 15px;
    margin: 0;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  .foot {
    background: #2d2d30;
    border-top: 1px solid #3e3e42;
    padding: 8px 20px;
    font-size: 12px;
    color: #888888;
  }
  
  .foot a {
    color: #007acc;
    text-decoration: none;
  }
  
  .foot a:hover {
    text-decoration: underline;
  }
  
  .back-btn {
    background: #5a5a5a;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .back-btn:hover {
    background: #6a6a6a;
    color: white;
    text-decoration: none;
  }
</style>
</head>
<body>

<!-- Ace Editor -->
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.23.4/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.23.4/src-min-noconflict/ext-language_tools.js"></script>

<div class="ide-container">
  <header class="topbar">
    <div class="tabs">
      <button class="tab active" data-lang="python">🐍 Python</button>
      <button class="tab" data-lang="cpp">⚡ C++</button>
    </div>
    <div class="actions">
      <a href="/" class="back-btn">← 返回首页</a>
      <button id="runBtn" class="btn run">▶️ 运行 (Ctrl+Enter)</button>
      <button id="clearBtn" class="btn">🗑️ 清空输出</button>
      <a class="btn" target="_blank" rel="noopener" href="/scratch">🧩 Scratch</a>
    </div>
  </header>

  <main class="workspace">
    <section class="editor-pane">
      <div id="editor"></div>
      <div class="stdin">
        <label>📥 标准输入（可选）</label>
        <textarea id="stdin" placeholder="在此输入运行时的标准输入...&#10;例如：&#10;3 4&#10;"></textarea>
      </div>
    </section>
    <section class="output-pane">
      <div class="output-toolbar">
        <span id="status">✅ 已就绪</span>
      </div>
      <pre id="output" class="output">欢迎使用在线代码编辑器！

支持的语言：
• Python：由 Pyodide 在浏览器中执行
• C++：使用 Judge0 公共 API（需联网）

快捷键：
• Ctrl+Enter：运行代码
• Ctrl+/：注释/取消注释
• Ctrl+Z：撤销
• Ctrl+Y：重做

开始编写你的代码吧！</pre>
    </section>
  </main>

  <footer class="foot">
    <small>
      💡 Python 由 <a target="_blank" rel="noopener" href="https://pyodide.org/">Pyodide</a> 在浏览器中执行；
      C++ 使用 <a target="_blank" rel="noopener" href="https://github.com/engineer-man/piston">Judge0</a> 公共 API（需联网）。
      参考：<a target="_blank" rel="noopener" href="/scratch">Scratch 图形化编程</a>
    </small>
  </footer>
</div>

<!-- Pyodide (Python in WebAssembly) -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
let editor;
let pyodide;
let currentLang = 'python';

const templates = {
  python: `# Python 示例代码
print("Hello, Python!")

# 计算两个数的和
a = int(input("请输入第一个数: "))
b = int(input("请输入第二个数: "))
result = a + b
print(f"结果: {a} + {b} = {result}")`,
  
  cpp: `// C++ 示例代码
#include <iostream>
using namespace std;

int main() {
    cout << "Hello, C++!" << endl;
    
    // 计算两个数的和
    int a, b;
    cout << "请输入两个数: ";
    cin >> a >> b;
    
    int result = a + b;
    cout << "结果: " << a << " + " << b << " = " << result << endl;
    
    return 0;
}`
};

// 初始化编辑器
function initEditor() {
  editor = ace.edit('editor');
  editor.setTheme('ace/theme/vs_dark');
  editor.session.setMode('ace/mode/python');
  editor.setValue(templates.python, -1);
  
  // 启用自动补全
  editor.setOptions({
    enableBasicAutocompletion: true,
    enableSnippets: true,
    enableLiveAutocompletion: true,
    fontSize: 14,
    showPrintMargin: false,
    wrap: true
  });
  
  // 快捷键
  editor.commands.addCommand({
    name: 'runCode',
    bindKey: {win: 'Ctrl-Enter', mac: 'Cmd-Enter'},
    exec: runCode
  });
}

// 切换语言
function switchLanguage(lang) {
  currentLang = lang;
  
  // 更新标签样式
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.lang === lang);
  });
  
  // 更新编辑器
  if (lang === 'python') {
    editor.session.setMode('ace/mode/python');
    editor.setValue(templates.python, -1);
  } else if (lang === 'cpp') {
    editor.session.setMode('ace/mode/c_cpp');
    editor.setValue(templates.cpp, -1);
  }
  
  clearOutput();
  updateStatus('已就绪');
}

// 更新状态
function updateStatus(message) {
  document.getElementById('status').textContent = message;
}

// 清空输出
function clearOutput() {
  document.getElementById('output').textContent = '';
}

// 输出内容
function outputText(text, isError = false) {
  const output = document.getElementById('output');
  const span = document.createElement('span');
  span.textContent = text + '\n';
  if (isError) {
    span.style.color = '#f48771';
  }
  output.appendChild(span);
  output.scrollTop = output.scrollHeight;
}

// 初始化 Python 环境
async function initPython() {
  if (!pyodide) {
    updateStatus('🔄 正在初始化Python环境...');
    try {
      pyodide = await loadPyodide();
      updateStatus('✅ Python环境已就绪');
    } catch (error) {
      updateStatus('❌ Python环境初始化失败');
      outputText('Python环境初始化失败: ' + error.message, true);
    }
  }
}

// 运行 Python 代码
async function runPython() {
  if (!pyodide) {
    await initPython();
    if (!pyodide) return;
  }
  
  const code = editor.getValue();
  const stdin = document.getElementById('stdin').value;
  
  updateStatus('🔄 正在执行Python代码...');
  
  try {
    // 设置标准输入
    if (stdin) {
      pyodide.globals.set('__stdin_data__', stdin.split('\n'));
      pyodide.globals.set('__stdin_index__', 0);
      
      // 重定义 input 函数
      pyodide.runPython(`
import builtins
def custom_input(prompt=''):
    if prompt:
        print(prompt, end='')
    if '__stdin_data__' in globals() and __stdin_index__ < len(__stdin_data__):
        line = __stdin_data__[__stdin_index__]
        globals()['__stdin_index__'] += 1
        print(line)
        return line
    return ''
builtins.input = custom_input
      `);
    }
    
    const result = pyodide.runPython(code);
    if (result !== undefined) {
      outputText('返回值: ' + result);
    }
    updateStatus('✅ 执行完成');
  } catch (error) {
    outputText('执行错误: ' + error.message, true);
    updateStatus('❌ 执行错误');
  }
}

// 运行 C++ 代码
async function runCpp() {
  const code = editor.getValue();
  const stdin = document.getElementById('stdin').value;
  
  updateStatus('🔄 正在执行C++代码...');
  
  try {
    // 尝试使用 Piston API
    const response = await fetch('https://emkc.org/api/v2/piston/execute', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        language: 'cpp',
        version: '10.2.0',
        files: [{
          content: code
        }],
        stdin: stdin
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    if (result.run) {
      if (result.run.stdout) {
        outputText('输出:\n' + result.run.stdout);
      }
      if (result.run.stderr) {
        outputText('错误:\n' + result.run.stderr, true);
      }
      if (result.run.code !== 0) {
        outputText(`程序退出码: ${result.run.code}`, true);
      }
      updateStatus('✅ 执行完成');
    } else {
      throw new Error('执行失败');
    }
  } catch (error) {
    outputText('执行错误: ' + error.message, true);
    outputText('\n💡 提示: C++代码需要网络连接到公共编译服务', true);
    updateStatus('❌ 执行错误');
  }
}

// 运行代码
async function runCode() {
  clearOutput();
  
  if (currentLang === 'python') {
    await runPython();
  } else if (currentLang === 'cpp') {
    await runCpp();
  }
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
  initEditor();
  
  // 标签切换事件
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      switchLanguage(tab.dataset.lang);
    });
  });
  
  // 按钮事件
  document.getElementById('runBtn').addEventListener('click', runCode);
  document.getElementById('clearBtn').addEventListener('click', clearOutput);
  
  // 初始化 Python 环境（延迟加载）
  setTimeout(initPython, 1000);
});
</script>
</body>
</html>
